<%- include('./userPartials/header') %>

<%- include('./userPartials/navbar') %>

<link rel="stylesheet" type="text/css" href="/user_css/homePage.css">

<style>
    .order-status li {
        font-size: 15px;
    }
    .cancel-button.disabled {
        background-color: grey;
        pointer-events: none; /* Prevent further interaction */
}

</style>
<section class="">
  <div class="container pt-3 pt-md-5">
      <% if (orderDetails.length < 1) { %>
      <div class="w-100">
          <img src="/images/no-order.png" width="30%" alt="no order image" class="img-fluid d-block m-auto" />
      </div>
      <% } else { %>
      <h2 class="text-charcoal hidden-sm-down">Order Summary</h2>
      <div class="row">
          <% orderDetails.forEach(data => { %>
          <div class="col-12 mb-3">
              <div class="list-group shadow-sm bg-body rounded">
                  <div class="list-group-item p-3 bg-light" style="position: relative;">
                      <div class="row w-100 no-gutters">
                          <div class="">
                              <h6 class="text-charcoal mb-0 w-100 d-inline fs-5"><span><strong><%= ++i %>. </strong></span>Order ID: </h6>
                              <a href="#" class="text-pebble mb-0 w-100 mb-2 mb-md-0 fs-5 text-decoration-none text-dark"><%= data._id %></a>
                          </div>
                      </div>
                  </div>
                  <div class="list-group-item p-3 bg-white">
                      <div class="row no-gutters">
                          <% if (data.status === 'Pending') { %>
                            <div class="">
                              <p class="d-flex justify-content-start align-items-center" style="color: #ffc107; font-weight: 600;"><i class="fa-solid fa-circle-dot" style="color: #ffc107; font-size: 10px; margin-right: 5px;"></i> <%= data.status %></p>
                          </div>
                           <% } else if (data.status ==='Cancelled') { %>
                            <div class="">
                              <p class="d-flex justify-content-start align-items-center" style="color: #d11326; font-weight: 600;"><i class="fa-solid fa-circle-dot" style="color: #d11326; font-size: 10px; margin-right: 5px;"></i> <%= data.status %></p>
                          </div>
                          <% } else if (data.status === 'Processing') { %>
                            <div class="">
                              <p class="d-flex justify-content-start align-items-center" style="color: #FF4500; font-weight: 600;"><i class="fa-solid fa-circle-dot" style="color: #FF4500; font-size: 10px; margin-right: 5px;"></i> <%= data.status %></p>
                          </div>
                          <% } else if (data.status === 'Shipped') { %>
                            <div class="">
                              <p class="d-flex justify-content-start align-items-center" style="color: #055C9D; font-weight: 600;"><i class="fa-solid fa-circle-dot" style="color: #055C9D; font-size: 10px; margin-right: 5px;"></i> <%= data.status %></p>
                          </div>
                          <% } else if (data.status === 'Delivered') { %>
                            <div class="">
                              <p class="d-flex justify-content-start align-items-center" style="color: #00b500; font-weight: 600;"><i class="fa-solid fa-circle-dot" style="color: #00b500; font-size: 10px; margin-right: 5px;"></i> <%= data.status %></p>
                          </div>
                          <% } %>
                          <div class="col-10 pr-0 pr-md-3">
                              <ul class="list-unstyled text-pebble mb-2 small order-status">
                                  <li class="mt-3">
                                    <b class="fs-6">Name: </b> <a href="" class="text-charcoal"><%= data.items[0].name %></a>
                                  </li>
                                  <li class="mt-3">
                                      <b class="fs-6">Size: </b> <%= data.items[0].size %>
                                  </li>
                                  <li class="mt-3">
                                      <b class="fs-6">Quantity: </b> <%= data.items[0].quantity %>
                                  </li>
                                  <li class="mt-3">
                                      <b class="fs-6">Total: </b> <span>&#8377</span><%= data.totalPrice %>
                                  </li>
                                  <li class="mt-3">
                                    <b class="fs-6">Shipped To: </b> <%= data.address[0].address %>
                                </li>
                                  <li class="mt-3">
                                    <b class="fs-6">Ordered Date: </b> <%= data.orderDate.toISOString().substring(0, 10) %>
                                </li>
                                <li class="mt-3">
                                    <b class="fs-6">Delivery Date: </b> <%= data.arrivingDate.toISOString().substring(0, 10) %>
                                </li> 
                              </ul>
                          </div>
                          <% if (data.status === 'Cancelled') { %>
                            <div class="col-2 hidden-sm-down">
                              <button disabled class="btn btn-secondary w-100 mb-2 cancel-button">Cancelled</button>
                            </div>
                           <% } else { %>
                            <% if (data.status === 'Delivered') { %>
                              <div class="col-2 hidden-sm-down">
                                <button id="cancelButton<%= data._id %>" disabled class="btn btn-danger w-100 mb-2 cancel-button" data-bs-toggle="modal" data-bs-target="#exampleModal<%= data._id %>">Cancel Order</button>
                              </div>
                              <% } else { %>
                               
                                <div class="col-2 hidden-sm-down">
                                  <button id="cancelButton<%= data._id %>" class="btn btn-danger w-100 mb-2 cancel-button" data-bs-toggle="modal" data-bs-target="#exampleModal<%= data._id %>">Cancel Order</button>
                                </div>
                            <% } %>
                          <% } %>
                      </div>
                  </div>
              </div>
          </div>
          <!-- Modal for Cancel Order -->
          <div class="modal fade" id="exampleModal<%= data._id %>" tabindex="-1" aria-labelledby="exampleModalLabel<%= data._id %>" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel<%= data._id %>">Cancel Order</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <textarea name="Reason" id="Reason<%= data._id %>" class="w-100 rounded-2 ps-2 form-control" rows="5" placeholder="Enter your reason..."></textarea>
                  </div>
                  <p id="cancellationReasonErrorMessage" class="mb-3 text-center" style="font-size: 13px; color: red;"></p>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="clearCancellationReason('<%= data._id %>')">Close</button>
                        <button type="button" class="btn btn-primary" onclick="submitCancellationReason('<%= data._id %>')">Submit</button>
                      </div>
                </div>
            </div>
        </div>
        
          <% }) %>
          <% } %>
      </div>
  </div>
</section>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>


  <script>

    
// Function to submit cancellation reason
function submitCancellationReason(orderId) {
  const reason = document.getElementById('Reason' + orderId).value.trim();
  const cancellationReasonErrorMessage = document.getElementById('cancellationReasonErrorMessage');
  const cancelButton = document.getElementById('cancelButton' + orderId);

  if (reason !== '') {
    const data = {
      orderId: orderId,
      cancellationReason: reason
    };

    Swal.fire({
      title: 'Are you sure?',
      text: "You won't be able to revert this!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, cancel it!'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch('/cancelOrder', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then(response => {
          if (response && response.success) {
            Swal.fire({
              title: 'Success',
              text: 'Order cancelled successfully!',
              icon: 'success'
            }).then(() => {
              window.location.reload();
            });
          } else {
            Swal.fire({
              title: 'Error',
              text: 'Error cancelling the order.',
              icon: 'error'
            });
          }
        })
        .catch(error => {
          console.error('Fetch error:', error);
          Swal.fire({
            title: 'Error',
            text: 'Error cancelling the order.',
            icon: 'error'
          });
        });
      }
    });
  } else {
    cancellationReasonErrorMessage.textContent = 'Please enter a cancellation reason.';
    return;
  }
}





    function clearCancellationReason(orderId) {
      document.getElementById('Reason' + orderId).value = ''; // Clear textarea value
      document.getElementById('cancellationReasonErrorMessage').textContent = '';
    }

  </script>






















<%- include('./userPartials/footer') %>
